name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write  # Required for keyless cosign (OIDC)

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    env:
      APP_NAME: gdrv
      REPO_NAME: MILCGroup/Google-Drive-CLI

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Import Code Signing Certificate
        if: env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p temp_password build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p temp_password build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k temp_password build.keychain
          rm certificate.p12

      - name: Build official binaries
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          COMMIT: ${{ github.sha }}
          DATE: ${{ github.event.head_commit.timestamp }}
          OAUTH_CLIENT_ID: ${{ secrets.GDRV_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.GDRV_CLIENT_SECRET }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          mkdir -p dist

          LDFLAGS="-s -w \
            -X github.com/milcgroup/gdrv/pkg/version.Version=${VERSION} \
            -X github.com/milcgroup/gdrv/pkg/version.GitCommit=${COMMIT} \
            -X github.com/milcgroup/gdrv/pkg/version.BuildTime=${DATE} \
            -X github.com/milcgroup/gdrv/internal/auth.BundledBuildSource=official"

          if [ -n "$OAUTH_CLIENT_ID" ]; then
            LDFLAGS="${LDFLAGS} -X github.com/milcgroup/gdrv/internal/auth.BundledOAuthClientID=${OAUTH_CLIENT_ID}"
          fi
          if [ -n "$OAUTH_CLIENT_SECRET" ]; then
            LDFLAGS="${LDFLAGS} -X github.com/milcgroup/gdrv/internal/auth.BundledOAuthClientSecret=${OAUTH_CLIENT_SECRET}"
          fi

          echo "Building official release with OAuth credentials..."

          GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-darwin-arm64 ./cmd/${APP_NAME}
          GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-darwin-amd64 ./cmd/${APP_NAME}

          # Sign with Developer ID if cert is available, otherwise ad-hoc
          if [ -n "$APPLE_CERTIFICATE" ]; then
            SIGN_IDENTITY="Developer ID Application"
          else
            SIGN_IDENTITY="-"
          fi
          codesign --sign "$SIGN_IDENTITY" --timestamp --options runtime dist/${APP_NAME}-darwin-arm64
          codesign --sign "$SIGN_IDENTITY" --timestamp --options runtime dist/${APP_NAME}-darwin-amd64

          GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-linux-amd64 ./cmd/${APP_NAME}

          GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-linux-arm64 ./cmd/${APP_NAME}

          GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-windows-amd64.exe ./cmd/${APP_NAME}

          GOOS=windows GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-windows-arm64.exe ./cmd/${APP_NAME}

      - name: Verify version metadata
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          DATE: ${{ github.event.head_commit.timestamp }}
        run: |
          go build -ldflags="-X github.com/milcgroup/gdrv/pkg/version.Version=${VERSION} -X github.com/milcgroup/gdrv/pkg/version.BuildTime=${DATE}" -o /tmp/${APP_NAME}-verify ./cmd/${APP_NAME}
          /tmp/${APP_NAME}-verify version | grep -F "${VERSION}"

      - name: Create Arch Linux PKGBUILD
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO_URL: https://github.com/${{ env.REPO_NAME }}
        run: |
          cat > dist/PKGBUILD << PKGBUILD_EOF
          pkgname=gdrv-bin
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="Company Google Drive CLI with pre-bundled OAuth credentials"
          arch=('x86_64' 'aarch64')
          url="${REPO_URL}"
          license=('MIT')
          provides=("gdrv")
          conflicts=("gdrv")

          source_x86_64=("${REPO_URL}/releases/download/${VERSION}/gdrv-linux-amd64")
          source_aarch64=("${REPO_URL}/releases/download/${VERSION}/gdrv-linux-arm64")

          sha256sums_x86_64=('SKIP')
          sha256sums_aarch64=('SKIP')

          package() {
            cd "\${srcdir}"
            install -Dm755 gdrv-linux-* "\${pkgdir}/usr/bin/gdrv"
          }
          PKGBUILD_EOF

          AMD64_SHA=$(shasum -a 256 dist/gdrv-linux-amd64 | awk '{print $1}')
          ARM64_SHA=$(shasum -a 256 dist/gdrv-linux-arm64 | awk '{print $1}')
          sed -i "" "s/sha256sums_x86_64=('SKIP')/sha256sums_x86_64=('${AMD64_SHA}')/" dist/PKGBUILD
          sed -i "" "s/sha256sums_aarch64=('SKIP')/sha256sums_aarch64=('${ARM64_SHA}')/" dist/PKGBUILD

      - name: Generate checksums
        run: |
          cd dist
          shasum -a 256 gdrv-* PKGBUILD > checksums.txt

      - name: Sign binaries with cosign (key-based)
        if: env.COSIGN_PRIVATE_KEY != ''
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          go install github.com/sigstore/cosign/v2/cmd/cosign@latest
          for file in dist/gdrv-*; do
            cosign sign-blob --key env://COSIGN_PRIVATE_KEY \
              --output-signature "${file}.sig" \
              --output-certificate "${file}.pem" \
              "$file"
          done

      - name: Sign binaries with cosign (keyless OIDC)
        if: env.COSIGN_PRIVATE_KEY == ''
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          go install github.com/sigstore/cosign/v2/cmd/cosign@latest
          for file in dist/gdrv-*; do
            cosign sign-blob --yes \
              --output-signature "${file}.sig" \
              --output-certificate "${file}.pem" \
              "$file"
          done

      - name: Sign checksums with GPG
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
            --detach-sign --armor dist/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/gdrv-darwin-arm64
            dist/gdrv-darwin-amd64
            dist/gdrv-linux-amd64
            dist/gdrv-linux-arm64
            dist/gdrv-windows-amd64.exe
            dist/gdrv-windows-arm64.exe
            dist/PKGBUILD
            dist/checksums.txt
            dist/*.sig
            dist/*.pem
            dist/checksums.txt.asc
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
