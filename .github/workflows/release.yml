name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write  # Required for keyless cosign (OIDC)

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    env:
      APP_NAME: gdrv
      REPO_NAME: MILCGroup/Google-Drive-CLI

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Import Code Signing Certificate
        if: env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p temp_password build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p temp_password build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k temp_password build.keychain
          rm certificate.p12

      - name: Build official binaries
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          COMMIT: ${{ github.sha }}
          DATE: ${{ github.event.head_commit.timestamp }}
          OAUTH_CLIENT_ID: ${{ secrets.GDRV_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.GDRV_CLIENT_SECRET }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          mkdir -p dist

          LDFLAGS="-s -w \
            -X github.com/milcgroup/gdrv/pkg/version.Version=${VERSION} \
            -X github.com/milcgroup/gdrv/pkg/version.GitCommit=${COMMIT} \
            -X github.com/milcgroup/gdrv/pkg/version.BuildTime=${DATE} \
            -X github.com/milcgroup/gdrv/internal/auth.BundledBuildSource=official"

          if [ -n "$OAUTH_CLIENT_ID" ]; then
            LDFLAGS="${LDFLAGS} -X github.com/milcgroup/gdrv/internal/auth.BundledOAuthClientID=${OAUTH_CLIENT_ID}"
          fi
          if [ -n "$OAUTH_CLIENT_SECRET" ]; then
            LDFLAGS="${LDFLAGS} -X github.com/milcgroup/gdrv/internal/auth.BundledOAuthClientSecret=${OAUTH_CLIENT_SECRET}"
          fi

          echo "Building official release with OAuth credentials..."

          GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-darwin-arm64 ./cmd/${APP_NAME}
          GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-darwin-amd64 ./cmd/${APP_NAME}

          # Sign with Developer ID if cert is available, otherwise ad-hoc
          if [ -n "$APPLE_CERTIFICATE" ]; then
            SIGN_IDENTITY="Developer ID Application"
          else
            SIGN_IDENTITY="-"
          fi
          codesign --sign "$SIGN_IDENTITY" --timestamp --options runtime dist/${APP_NAME}-darwin-arm64
          codesign --sign "$SIGN_IDENTITY" --timestamp --options runtime dist/${APP_NAME}-darwin-amd64

          GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-linux-amd64 ./cmd/${APP_NAME}

          GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-linux-arm64 ./cmd/${APP_NAME}

          GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-windows-amd64.exe ./cmd/${APP_NAME}

          GOOS=windows GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/${APP_NAME}-windows-arm64.exe ./cmd/${APP_NAME}

      - name: Verify version metadata
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          DATE: ${{ github.event.head_commit.timestamp }}
        run: |
          go build -ldflags="-X github.com/milcgroup/gdrv/pkg/version.Version=${VERSION} -X github.com/milcgroup/gdrv/pkg/version.BuildTime=${DATE}" -o /tmp/${APP_NAME}-verify ./cmd/${APP_NAME}
          /tmp/${APP_NAME}-verify version | grep -F "${VERSION}"

      - name: Create Arch Linux PKGBUILD
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO_URL: https://github.com/${{ env.REPO_NAME }}
        run: |
          cat > dist/PKGBUILD << PKGBUILD_EOF
          pkgname=gdrv-bin
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="Company Google Drive CLI with pre-bundled OAuth credentials"
          arch=('x86_64' 'aarch64')
          url="${REPO_URL}"
          license=('MIT')
          provides=("gdrv")
          conflicts=("gdrv")

          source_x86_64=("${REPO_URL}/releases/download/${VERSION}/gdrv-linux-amd64")
          source_aarch64=("${REPO_URL}/releases/download/${VERSION}/gdrv-linux-arm64")

          sha256sums_x86_64=('SKIP')
          sha256sums_aarch64=('SKIP')

          package() {
            cd "\${srcdir}"
            install -Dm755 gdrv-linux-* "\${pkgdir}/usr/bin/gdrv"
          }
          PKGBUILD_EOF

          AMD64_SHA=$(shasum -a 256 dist/gdrv-linux-amd64 | awk '{print $1}')
          ARM64_SHA=$(shasum -a 256 dist/gdrv-linux-arm64 | awk '{print $1}')
          sed -i "" "s/sha256sums_x86_64=('SKIP')/sha256sums_x86_64=('${AMD64_SHA}')/" dist/PKGBUILD
          sed -i "" "s/sha256sums_aarch64=('SKIP')/sha256sums_aarch64=('${ARM64_SHA}')/" dist/PKGBUILD

      - name: Generate checksums
        run: |
          cd dist
          shasum -a 256 gdrv-* PKGBUILD > checksums.txt

      - name: Sign binaries with cosign (key-based)
        if: env.COSIGN_PRIVATE_KEY != ''
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          go install github.com/sigstore/cosign/v2/cmd/cosign@latest
          for file in dist/gdrv-*; do
            cosign sign-blob --key env://COSIGN_PRIVATE_KEY \
              --output-signature "${file}.sig" \
              --output-certificate "${file}.pem" \
              "$file"
          done

      - name: Sign binaries with cosign (keyless OIDC)
        if: env.COSIGN_PRIVATE_KEY == ''
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          go install github.com/sigstore/cosign/v2/cmd/cosign@latest
          for file in dist/gdrv-*; do
            cosign sign-blob --yes \
              --output-signature "${file}.sig" \
              --output-certificate "${file}.pem" \
              "$file"
          done

      - name: Sign checksums with GPG
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
            --detach-sign --armor dist/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/gdrv-darwin-arm64
            dist/gdrv-darwin-amd64
            dist/gdrv-linux-amd64
            dist/gdrv-linux-arm64
            dist/gdrv-windows-amd64.exe
            dist/gdrv-windows-arm64.exe
            dist/PKGBUILD
            dist/checksums.txt
            dist/*.sig
            dist/*.pem
            dist/checksums.txt.asc
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify forks
        env:
          GH_TOKEN: ${{ secrets.FORKS_DISPATCH_TOKEN }}
          RELEASE_TAG: ${{ github.ref_name }}
          RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          PAGE=1
          while true; do
            FORKS=$(gh api "repos/$REPO/forks?per_page=100&page=$PAGE" --jq '.[].full_name')
            [ -z "$FORKS" ] && break

            for FORK in $FORKS; do
              echo "Dispatching to $FORK"
              gh api "repos/$FORK/dispatches" \
                --method POST \
                --field event_type=upstream-release \
                --field "client_payload[tag]=$RELEASE_TAG" \
                --field "client_payload[url]=$RELEASE_URL" \
                --field "client_payload[upstream]=$REPO" \
                2>&1 || echo "  Skipped $FORK (no permission or workflow not present)"
            done

            PAGE=$((PAGE + 1))
          done

      - name: Update Homebrew Tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          SHA256_ARM64=$(sha256sum dist/gdrv-darwin-arm64.tar.gz | awk '{print $1}')
          SHA256_AMD64=$(sha256sum dist/gdrv-darwin-amd64.tar.gz | awk '{print $1}')
          SHA256_LINUX_ARM64=$(sha256sum dist/gdrv-linux-arm64.tar.gz | awk '{print $1}')
          SHA256_LINUX_AMD64=$(sha256sum dist/gdrv-linux-amd64.tar.gz | awk '{print $1}')

          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/dl-alexandre/tap.git tap-repo
          cd tap-repo

          cat > Formula/gdrv.rb << EOF
          class Gdrv < Formula
            desc "Google Drive CLI with full read/write support"
            homepage "https://github.com/dl-alexandre/Google-Drive-CLI"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/dl-alexandre/Google-Drive-CLI/releases/download/${VERSION}/gdrv-darwin-arm64.tar.gz"
                sha256 "${SHA256_ARM64}"
              end
              if Hardware::CPU.intel?
                url "https://github.com/dl-alexandre/Google-Drive-CLI/releases/download/${VERSION}/gdrv-darwin-amd64.tar.gz"
                sha256 "${SHA256_AMD64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/dl-alexandre/Google-Drive-CLI/releases/download/${VERSION}/gdrv-linux-arm64.tar.gz"
                sha256 "${SHA256_LINUX_ARM64}"
              end
              if Hardware::CPU.intel?
                url "https://github.com/dl-alexandre/Google-Drive-CLI/releases/download/${VERSION}/gdrv-linux-amd64.tar.gz"
                sha256 "${SHA256_LINUX_AMD64}"
              end
            end

            def install
              bin.install "gdrv"
            end

            test do
              system "#{bin}/gdrv", "version"
            end
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gdrv.rb
          git commit -m "Update gdrv to ${VERSION}"
          git push
